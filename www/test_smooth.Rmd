---
title: "Testing an inversion strategy"
author: "R. Grdina, W. Bauer"
date: "September 8, 2015"
output: html_document
---

```{r message=FALSE, warning=FALSE}
source("../R/smooth.R")
source("../R/system_matrix_utils.R")
source("../R/utilities.R")
library(Matrix)
```

The DVT use case would involve system matrices whose column-to-row ratios would be upwards of 6 to 1. These matrices would be of very low rank. Thus there would be very large affine spaces of images which would give equally good fits to time-of-flight data. To mitigate the problem, additional constraints could be employed. This note covers some exploratory work along these lines.

An 8x24 image is generated as follows. Assuming 8 transducers, its associated system matrix, $S,$ will be $64=8^2$ by $192=8\times 24.$ It is thus quite singular. Times of flight, $\tau,$ are generated by multiplying the (unrasterized) image by $S$.

```{r fig.show='hold', fig.align='center', fig.height=4.5}
ap <- read.table("../data/acoustic_properties_thigh.csv", sep=',', header=TRUE, as.is=TRUE)
img <- testImage(24,8,1,1/1450) # fat background
img[4:14, 2:5] <- 1/1585  # muscle
img[19:20, 6:7] <- 1/1584 # vessel
img[1, 1:8] <- 1/1660   # skin
img[24, 1:8] <- 1/1660  # skin
ys <- probeYs(8, img)
S <- genS(8,24,1)
tau <- S %*% as.vector(img)
plotTestImage(img)
gridOverlay(img)
probeOverlay(ys, img, col=c("black", "white"))
```

Square singular matrices have determinant zero. This means they satisfy an algebraic equation of high degree, hence they lie on a curved surface of dimension one less than that of the entire space of matrices of the same shape. This curved surface has measure zero, just as a curved line has no area, a planar shape has no volume, etc. As a result, a random square matrix is almost surely invertible. Similarly, the sum of two unrelated singular matrices is very likely to be invertible.

To assume tissues consist of relatively flat areas delineated by relatively sharp boundaries is a rough approximation, but one which implies adjacent pixels look very much alike most of the time. Thus, differences of adjacent pixels will be small most of the time. They will not be small at tissue boundaries, hence imposing the assumption will result in blurred edges. However, for exploratory purposes that is the strategy here. 

Let $b$ be a 192 long vector representing an (unrasterized 8x24) image. Differences between adjacent pixels can be implemented as matrix multiplications. Let $H$ and $V$ represent horizontal and vertical differences, respectively. $H$ and $V$ are 192x192 square matrices. If applied to the test image, they would produce zeros except at "tissue" boundaries.

Now, instead of minimizing the quadratic form $||Sb-\tau||^2$, we minimize$$||Sb-\tau||^2 + w(||Hb||^2 + ||Vb||^2)$$where $w$ is a weight. Setting the gradient of this form to zero gives,$$\left[S^TS + w(H^TH + V^TV)\right]b = S^T\tau.$$Provided the matrix on the left is nonsigular, the equation can be solved uniquely for $b$. As expected, the matrix *is* nonsingular, and the recovered image has blurred edges. Four examples are shown.

```{r fig.align='center', fig.show='hold', fig.height=4.5}
H <- formH(8, 24)
V <- formV(8, 24)
HTH <- t(H) %*% H
VTV <- t(V) %*% V
STS <- t(S) %*% S
bhat <- solve(STS + 1.0*(HTH+VTV), t(S) %*% tau)
ihat <- as.testImage(matrix(bhat, 24, 8), 1)
plotTestImage(ihat, main="H and V weight = 1.0")
bhat2 <- solve(STS + .10*(HTH+VTV), t(S) %*% tau)
ihat2 <- as.testImage(matrix(bhat2, 24, 8), 1)
plotTestImage(ihat2, main="H and V weight = 1e-1")
bhat3 <- solve(STS + 1e-2*(HTH+VTV), t(S) %*% tau)
ihat3 <- as.testImage(matrix(bhat3, 24, 8), 1)
plotTestImage(ihat3, main="H and V weight = 1e-2")
bhat4 <- solve(STS + 1e-6*(HTH+VTV), t(S) %*% tau)
ihat4 <- as.testImage(matrix(bhat4, 24, 8), 1)
plotTestImage(ihat4, main="H and V weight = 1e-6")
```

